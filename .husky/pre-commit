#!/usr/bin/env bash

set -euo pipefail

###############################################################################
# 1. Enforce tests for *Constants.cls classes
###############################################################################

check_constants_tests() {
  scripts/check_constants_tests.sh --staged
}

###############################################################################
# Collect staged files (for other checks)
###############################################################################

CHANGED_FILES="$(git diff --cached --name-only)"

changed_matches() {
  # Usage: changed_matches "pattern"
  echo "$CHANGED_FILES" | grep -q "$1"
}
###############################################################################
# 2. JavaScript linting (Aura & LWC)
###############################################################################

run_js_linters() {
  if changed_matches '^.*\/aura\/.*\.js$'; then
    echo "Running lint:aura..."
    npm run lint:aura
  fi

  if changed_matches '^.*\/lwc\/.*\.js$'; then
    echo "Running lint:lwc..."
    npm run lint:lwc
  fi
}

###############################################################################
# 3. Apex / metadata checks (regex + PMD)
###############################################################################

run_apex_checks() {
  if ! changed_matches '^force-app/main/default/'; then
    return 0
  fi

  echo "Running REGEX..."
  output="$(npm run regex)"
  if echo "$output" | grep -q "severity violation"; then
    echo "$output"
    exit 1
  fi

  echo "Running PMD..."
  npm run pmd
}

###############################################################################
# Main
###############################################################################

check_constants_tests
run_js_linters
run_apex_checks